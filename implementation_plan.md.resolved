# Implementation Plan - Advanced Security & Updater

## User Review Required
*   **Infrastructure**: You MUST host the generated `license_server.php` and `version.json` on a real web server (e.g., `recodestudio.it`).
*   **Tampering**: I will implement NTP check. If internet is available but blocked by firewall, check might fail. If internet unavailable, grace period applies.
*   **Encryption**: Python code will be compiled to bytecode and packaged in an Exe (PyInstaller). This is not "text in clear", but a determined hacker can always reverse engineer. This is industry standard for this level of app.

## Proposed Changes

### 1. Online Verification & Grace Period
*   **Server**: `license_server.php` (checks MySQL DB).
*   **App Logic**:
    *   **On Start**:
        1.  Check Internet.
        2.  **IF Online**: Call API to verify Key + Machine ID.
            *   **IF Valid**: Update `LastVerifiedTime` in Registry (Signed). Reset Grace Period.
            *   **IF Revoked/Invalid**: **BLOCK APP** immediately. Show "License Revoked".
        3.  **IF Offline**:
            *   Read `LastVerifiedTime`.
            *   If `CurrentTime - LastVerifiedTime > 72 hours`: **BLOCK APP**. Show "Connect to Internet to verify".
            *   Else: Allow run (Grace Period).

### 2. Anti-Tamper (Time & Code)
*   **Time Check**:
    *   Query `pool.ntp.org` to get real time.
    *   Compare with `System Time`.
    *   If difference > 1 hour -> **BLOCK APP** "System time incorrect".
*   **Obfuscation**:
    *   PyInstaller bundles `.pyc` (bytecode), not [.py](file:///c:/Users/Renato%20Cultrera/.gemini/antigravity/scratch/modbus_reader/build.py).
    *   I will add minor variable name obfuscation/indirection in the critical check function.

### 3. Auto-Updater
*   **Server**: `version.json` `{"version": "1.5", "url": "https://.../Setup.exe"}`.
*   **App Logic**:
    *   Compare `APP_VERSION` const with `version.json`.
    *   If Server > App:
        *   Prompt "Update Available".
        *   Download `Setup.exe` to temp.
        *   Run `Setup.exe /SILENT` and exit.

### 4. KeyGen Upgrade (Manager)
*   **Local DB**: Store user details.
*   **Sync**: Allow KeyGen to send "ADD LICENSE" commands to your PHP server so the online verification works.

## Files
*   `php/license_server.php`: The backend logic.
*   `php/db_schema.sql`: Database structure.
*   [modbus_reader.py](file:///c:/Users/Renato%20Cultrera/.gemini/antigravity/scratch/modbus_reader/modbus_reader.py): Updated with all new security logic.

## Verification
1.  **Tamper Time**: Change PC clock to last year. App should detect diff with NTP and block.
2.  **Revocation**: Mark key as 'REVOKED' in DB (simulated). App should block even if previously valid.
3.  **Grace Period**: Disconnect Wifi. App runs. Wait (simulate) 73 hours. App blocks.
